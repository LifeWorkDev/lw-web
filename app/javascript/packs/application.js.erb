import 'bootstrap.native/dist/bootstrap-native-v4'
import bugsnag from '@bugsnag/js'
import bugsnagReact from '@bugsnag/plugin-react'
import React from 'react'

require('@rails/ujs').start()
require('turbolinks').start()

window.bugsnagClient = bugsnag({ apiKey: 'c5a97432b84ea8031cc78cc2997cb2ba', releaseStage: '<%= Rails.env %>', notifyReleaseStages: <%= NOTIFY_RELEASE_STAGES %>, appVersion: '<%= ENV['HEROKU_RELEASE_VERSION'] || 'dev' %>', logger: null })
window.bugsnagClient.use(bugsnagReact, React)

require.context('../images', true)
// Support component names relative to this directory:
require('react_ujs').useContext(require.context('components', true))

// Goes last to allow overriding css from packages imported via React components
import 'application/application.scss'

document.addEventListener('turbolinks:load', function() {
  BSN.initCallback()
})

window.createPayMethod = function(data) {
  const csrf = document
    .querySelector("meta[name='csrf-token']")
    .getAttribute('content')
  window
    .fetch(`/c/pay_methods`, {
      body: JSON.stringify({
        pay_method: data
      }),
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrf,
      },
      method: 'POST',
      mode: 'cors',
    })
    .then(response => {
      if (response.ok) {
        const params = new URLSearchParams(window.location.search)
        window.location = `/c/milestone_projects/${params.get('project')}/deposit`
      } else {
        console.error(response)
        window.bugsnagClient.metaData = { response: response }
        window.bugsnagClient.notify(new Error('Payment Method creation error'))
      }
    })
}
